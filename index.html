<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø£Ù…Ø§ÙƒÙ†</title>

<!-- PWA Meta Tags -->
<meta name="theme-color" content="#2563eb">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="manifest" href="manifest.json">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
@import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');

:root{
  --main:#2563eb;
  --bg:#f4f6f8;
  --card:#ffffff;
  --text:#1f2937;
  --muted:#6b7280;
  --accent:#10b981;
  --success:#22c55e;
  --warning:#f59e0b;
  --danger:#ef4444;
  --border:#e5e7eb;
}

/* Dark Mode Variables */
body.dark,
body{
  --bg:#0f172a;
  --card:#1e293b;
  --text:#e5e7eb;
  --muted:#94a3b8;
  --border:#334155;
}

*{box-sizing:border-box}

body{
  margin:0;
  font-family: "Cairo", "Segoe UI", Tahoma, sans-serif;
  direction: rtl;
  background:var(--bg);
  color:var(--text);
  transition:background 0.3s, color 0.3s;
}

/* ---------- HEADER ---------- */
header{
  background:var(--main);
  color:#fff;
  padding:12px 15px;
  text-align:center;
  font-size:18px;
  font-weight:600;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
}

.brand{
  display:flex;
  align-items:center;
  gap:10px;
  font-weight:700;
}

.brand img{
  width:32px;
  height:32px;
  border-radius:8px;
  object-fit:cover;
}

.header-buttons{
  display:flex;
  gap:10px;
}

.welcome-bar{
  background:rgba(255,255,255,0.08);
  color:#fff;
  text-align:center;
  padding:8px 12px;
  font-size:14px;
  font-weight:600;
  overflow:hidden;
  white-space:nowrap;
  border-bottom:1px solid rgba(255,255,255,0.15);
}

.welcome-text{
  display:inline-block;
  animation:welcome-marquee 12s linear infinite;
}

@keyframes welcome-marquee{
  0%{transform:translateX(100%)}
  100%{transform:translateX(-100%)}
}

.theme-btn{
  background:rgba(255,255,255,0.2);
  border:none;
  color:white;
  width:40px;
  height:40px;
  border-radius:50%;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
}

.download-btn{
  background:linear-gradient(135deg, #f59e0b, #f97316);
  color:#111827;
  border:none;
  padding:8px 12px;
  border-radius:999px;
  font-size:13px;
  font-weight:700;
  cursor:pointer;
  box-shadow:0 6px 14px rgba(249,115,22,0.35);
}

.download-btn:hover{
  transform:translateY(-1px);
  box-shadow:0 10px 18px rgba(249,115,22,0.45);
}

/* ---------- COMMON ---------- */
.page{padding:15px}
.hidden{display:none}

.details-card{
  max-width:560px;
  margin:20px auto 40px;
  background:var(--card);
  border:2px solid var(--border);
  border-radius:16px;
  padding:16px;
  box-shadow:0 6px 20px rgba(0,0,0,0.15);
  overflow:hidden;
}

@media (max-width: 600px){
  header{
    padding:10px 12px;
    font-size:16px;
  }

  .brand img{
    width:28px;
    height:28px;
  }

  .page{
    padding:12px;
  }

  .details-card{
    margin:12px auto 24px;
    padding:12px;
  }

  .grid{
    grid-template-columns:repeat(auto-fill,minmax(130px,1fr));
  }

  .subcategory-grid{
    grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
  }

  .places-grid{
    grid-template-columns:repeat(auto-fit,120px);
    gap:6px;
  }

  .places-grid .item{
    width:120px;
    height:120px;
    padding:10px;
  }

  .search-box{
    font-size:14px;
    padding:12px 14px;
    flex:1 1 100%;
    max-width:100%;
  }

  .btn{
    font-size:14px;
    padding:9px 12px;
    width:100%;
  }
}

/* ---------- LOADING SKELETON ---------- */
.skeleton{
  animation:skeleton-loading 1.5s infinite;
  background:linear-gradient(90deg, var(--border) 25%, #f0f0f0 50%, var(--border) 75%);
  background-size:200% 100%;
}

@keyframes skeleton-loading{
  0%{background-position:200% 0}
  100%{background-position:-200% 0}
}

.skeleton-item{
  height:80px;
  border-radius:14px;
  margin-bottom:10px;
}

.skeleton-card{
  height:100px;
  border-radius:14px;
}

/* ---------- SEARCH ---------- */
.search-container{
  margin:15px 0 20px 0;
  position:relative;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

.search-box{
  flex:1 1 200px;
  padding:14px 20px;
  border:2px solid var(--border);
  border-radius:12px;
  font-size:16px;
  background:var(--card);
  color:var(--text);
  transition:.2s;
  min-width:0;
}

.search-box:focus{
  outline:none;
  border-color:var(--main);
}

.search-results{
  max-height:300px;
  overflow-y:auto;
  margin-top:10px;
  border-radius:10px;
  background:var(--card);
  box-shadow:0 4px 20px rgba(0,0,0,0.15);
  display:none;
  position:absolute;
  width:100%;
  z-index:1000;
  border:1px solid var(--border);
}

.search-result-item{
  padding:12px 15px;
  border-bottom:1px solid var(--border);
  cursor:pointer;
  transition:.2s;
}

.search-result-item:hover{
  background:rgba(37,99,235,0.1);
}

.search-result-category{
  font-size:12px;
  color:var(--muted);
  margin-top:3px;
}

/* ---------- BADGES ---------- */
.badge{
  display:inline-block;
  padding:3px 8px;
  border-radius:20px;
  font-size:12px;
  font-weight:600;
  margin-right:5px;
}

.badge-open{
  background:var(--success);
  color:white;
}

.badge-closed{
  background:var(--danger);
  color:white;
}


/* ---------- CATEGORIES ---------- */
.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(150px,1fr));
  gap:12px;
}

.card{
  background:var(--card);
  padding:20px 10px;
  border-radius:14px;
  text-align:center;
  cursor:pointer;
  box-shadow:0 4px 12px rgba(0,0,0,.06);
  transition:.2s;
  font-weight:500;
  border:2px solid transparent;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:8px;
}
.card:hover{
  transform:translateY(-3px);
  border-color:var(--main);
  box-shadow:0 8px 20px rgba(0,0,0,0.1);
}

.card-icon{
  font-size:24px;
  opacity:0.8;
}

.subcategory-grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(140px,1fr));
  gap:10px;
}

/* ---------- PLACES GRID ---------- */
.places-grid{
  display:grid;
  grid-template-columns:repeat(auto-fit,140px);
  gap:4px;
  justify-content:center;
}

.places-grid .item{
  margin-bottom:0;
  width:140px;
  height:140px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  align-items:center;
  padding:12px;
  gap:10px;
}

.places-grid .item-name{
  font-size:12px;
  line-height:1.2;
  text-align:center;
  white-space:normal;
  overflow:visible;
}

.places-grid .item-status{
  display:flex;
  justify-content:center;
}

.places-grid .item-footer{
  font-size:12px;
}

.places-grid .item:hover{
  transform:translateY(-3px);
}

/* ---------- PLACES ITEMS ---------- */
.item{
  background:var(--card);
  padding:15px;
  border-radius:14px;
  margin-bottom:10px;
  box-shadow:0 3px 10px rgba(0,0,0,.05);
  cursor:pointer;
  transition:.2s;
  border:1px solid var(--border);
}

.item:hover{
  transform:translateX(-5px);
  box-shadow:0 5px 15px rgba(0,0,0,.08);
}

.item-header{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  margin-bottom:8px;
}

.item-name{
  font-weight:600;
  font-size:16px;
  flex:1;
}

.item-category{
  font-size:12px;
  color:var(--muted);
  margin:3px 0;
}

.item-footer{
  display:flex;
  justify-content:space-between;
  margin-top:10px;
  font-size:13px;
  color:var(--muted);
}

/* ---------- NAVIGATION ---------- */
.back{
  background:none;
  border:none;
  color:var(--main);
  font-size:15px;
  margin-bottom:10px;
  cursor:pointer;
  display:flex;
  align-items:center;
  gap:5px;
  padding:8px 0;
}

.back:hover{
  opacity:0.8;
}

/* ---------- BUTTONS ---------- */
.btn{
  padding:10px 14px;
  border:none;
  border-radius:12px;
  background:var(--main);
  color:#fff;
  font-size:15px;
  cursor:pointer;
  transition:.2s;
  font-weight:500;
}

.btn:hover{
  background:#1d4ed8;
  transform:translateY(-2px);
}

.btn-secondary{
  background:var(--card);
  color:var(--text);
  border:2px solid var(--border);
}

.btn-secondary:hover{
  background:var(--border);
}

.btn-group{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-top:15px;
}

.btn-group .btn{
  margin:0;
}

/* ---------- DETAILS ---------- */
.info{
  margin:10px 0;
  padding:10px 0;
  border-bottom:1px solid var(--border);
  display:flex;
  align-items:center;
  gap:10px;
}

.info-days{
  font-size:12px;
}

.info span{
  overflow-wrap:anywhere;
  word-break:break-word;
}

.info-icon{
  font-size:18px;
  opacity:0.7;
}

/* ---------- MAP ---------- */
#map{
  height:calc(100vh - 50px);
}

.route-info{
  position:absolute;
  top:60px;
  left:15px;
  right:15px;
  background:white;
  padding:15px;
  border-radius:12px;
  box-shadow:0 4px 20px rgba(0,0,0,0.2);
  z-index:1000;
  text-align:center;
  font-weight:600;
  color:#1f2937;
}

/* ---------- PWA INSTALL PROMPT ---------- */
#installPrompt{
  position:fixed;
  bottom:20px;
  left:20px;
  right:20px;
  background:var(--card);
  padding:15px;
  border-radius:12px;
  box-shadow:0 8px 30px rgba(0,0,0,0.2);
  z-index:9999;
  display:none;
  border:2px solid var(--main);
}

.install-buttons{
  display:flex;
  gap:10px;
  margin-top:10px;
}

.install-btn{
  flex:1;
  padding:10px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:500;
}

.install-btn-primary{
  background:var(--main);
  color:white;
}

.install-btn-secondary{
  background:var(--border);
  color:var(--text);
}
</style>
</head>

<body>

<header>
  <div class="brand">
    <img src="logo.png" alt="Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø£Ù…Ø§ÙƒÙ†">
    <div>Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø£Ù…Ø§ÙƒÙ†</div>
  </div>
  <div class="header-buttons">
    <a class="download-btn" id="downloadBtn" href="#" target="_blank" rel="noopener">Ø­Ù…Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚</a>
    <button class="theme-btn" onclick="go('home')"><i class="fa-solid fa-house"></i></button>
  </div>
</header>

<div class="welcome-bar">
  <span class="welcome-text" id="welcomeText">Ø§Ù‡Ù„Ø§ Ø¨Ùƒ ÙÙŠ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø§Ù…Ø§ÙƒÙ† ÙÙŠ Ù…Ù†Ø·Ù‚Ø© Ø¯ÙˆÙ…Ø§</span>
</div>

<!-- HOME -->
<div id="home" class="page">
  <h3>Ø§Ù„ØªØµÙ†ÙŠÙØ§Øª</h3>
  
  <!-- Search Box -->
  <div class="search-container">
    <input type="text" 
           id="searchInput" 
           class="search-box" 
           placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…ÙƒØ§Ù† Ø¨Ø§Ø³Ù…Ù‡...">
    <select id="areaSelect" class="search-box" style="max-width:140px;">
      <option value="">ÙƒÙ„ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
      <option value="Ø¯ÙˆÙ…Ø§">Ø¯ÙˆÙ…Ø§</option>
      <option value="Ø­Ø±Ø³ØªØ§">Ø­Ø±Ø³ØªØ§</option>
      <option value="Ù…Ø³Ø±Ø§Ø¨Ø§">Ù…Ø³Ø±Ø§Ø¨Ø§</option>
    </select>
    <button class="btn btn-secondary" id="searchBtn"><i class="fa-solid fa-magnifying-glass"></i> Ø¨Ø­Ø«</button>
    <div id="searchResults" class="search-results"></div>
  </div>
  
  <div id="categories" class="grid"></div>
</div>

<!-- PLACES -->
<div id="places" class="page hidden">
  <button class="back" onclick="goBackFromPlaces()">â¬… Ø±Ø¬ÙˆØ¹</button>
  <h3 id="placesTitle"></h3>
  <div id="placesList" style="height:70vh;overflow-y:auto;"></div>
</div>

<!-- DETAILS -->
<div id="details" class="page hidden">
  <button class="back" onclick="goBackFromDetails()">â¬… Ø±Ø¬ÙˆØ¹</button>
  <div class="details-card">
    <h3 id="name"></h3>
    <div id="statusBadge" style="margin:10px 0"></div>
    
    <div class="info">
      <span class="info-icon">ğŸ“</span>
      <span id="category"></span>
    </div>
    
    <div class="info">
      <span class="info-icon">ğŸ“</span>
      <span id="phone"></span>
    </div>
    
    <div class="info">
      <span class="info-icon">ğŸ•’</span>
      <span id="hours"></span>
    </div>

    <div class="info info-days">
      <span class="info-icon">ğŸ“…</span>
      <span id="workdays"></span>
    </div>
    
    <div class="info">
      <span class="info-icon">ğŸ‘</span>
      <span id="views"></span>
    </div>
    
    <div class="btn-group">
      <button class="btn" onclick="openMap()">ğŸ—ºï¸ Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„Ù…ÙƒØ§Ù†</button>
    </div>
  </div>
</div>

<!-- MAP -->
<div id="mapPage" class="page hidden">
  <button class="back" onclick="go('details')" style="padding:10px">â¬… Ø±Ø¬ÙˆØ¹</button>
  <div id="map"></div>
</div>

<!-- PWA INSTALL PROMPT -->
<div id="installPrompt">
  <strong>ØªØ«Ø¨ÙŠØª ØªØ·Ø¨ÙŠÙ‚ Ø¯Ù„ÙŠÙ„ Ø§Ù„Ø£Ù…Ø§ÙƒÙ†</strong>
  <p>Ø«Ø¨Ù‘Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù„ÙˆØµÙˆÙ„ Ø§Ù„Ø³Ø±ÙŠØ¹ ÙˆØ§Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø£ÙØ¶Ù„</p>
  <div class="install-buttons">
    <button class="install-btn install-btn-primary" onclick="installApp()">âœ… ØªØ«Ø¨ÙŠØª</button>
    <button class="install-btn install-btn-secondary" onclick="hideInstallPrompt()">âœ–ï¸ Ù„Ø§Ø­Ù‚Ø§Ù‹</button>
  </div>
</div>

<!-- SCRIPTS -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/backendless@7/dist/backendless.min.js"></script>

<script>
/* ================= CONFIG ================= */
const BACKENDLESS_BASE_URL = "https://gallantquilt-us.backendless.app";
const PLACES_ENDPOINT = `${BACKENDLESS_BASE_URL}/api/data/Place`;
const APPLOCK_ENDPOINT = `${BACKENDLESS_BASE_URL}/api/data/AppLock`;

/* ================= STATE ================= */
let currentCategory = null;
let currentSubcategory = null;
let currentPlaceId = null;
let map;
let allPlaces = [];
let deferredPrompt = null;

let page = 1;
let pageSize = 10;
let loading = false;
let lastListPage = "home";
let listMode = "categories";
let selectedArea = "";

function getDamascusNow(){
  const now = new Date();
  const parts = new Intl.DateTimeFormat("en-GB", {
    timeZone: "Asia/Damascus",
    hour: "2-digit",
    minute: "2-digit",
    weekday: "long",
    hour12: false
  }).formatToParts(now);

  const get = (type) => parts.find(p=>p.type===type)?.value || "";
  return {
    dayEn: get("weekday"),
    time24: `${get("hour")}:${get("minute")}`
  };
}

function normalizeDayName(name){
  const n = String(name || "").trim().toLowerCase();
  const map = {
    "sunday": "Ø§Ù„Ø§Ø­Ø¯",
    "monday": "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†",
    "tuesday": "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡",
    "wednesday": "Ø§Ù„Ø§Ø±Ø¨Ø¹Ø§Ø¡",
    "thursday": "Ø§Ù„Ø®Ù…ÙŠØ³",
    "friday": "Ø§Ù„Ø¬Ù…Ø¹Ø©",
    "saturday": "Ø§Ù„Ø³Ø¨Øª",
    "Ø§Ù„Ø£Ø­Ø¯": "Ø§Ù„Ø§Ø­Ø¯",
    "Ø§ï»·Ø­Ø¯": "Ø§Ù„Ø§Ø­Ø¯",
    "Ø§Ù„Ø§Ø­Ø¯": "Ø§Ù„Ø§Ø­Ø¯",
    "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†": "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†",
    "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†": "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†",
    "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†": "Ø§Ù„Ø§Ø«Ù†ÙŠÙ†",
    "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡": "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡",
    "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡": "Ø§Ù„Ø§Ø±Ø¨Ø¹Ø§Ø¡",
    "Ø§Ù„Ø§Ø±Ø¨Ø¹Ø§Ø¡": "Ø§Ù„Ø§Ø±Ø¨Ø¹Ø§Ø¡",
    "Ø§Ù„Ø®Ù…ÙŠØ³": "Ø§Ù„Ø®Ù…ÙŠØ³",
    "Ø§Ù„Ø¬Ù…Ø¹Ø©": "Ø§Ù„Ø¬Ù…Ø¹Ø©",
    "Ø§Ù„Ø³Ø¨Øª": "Ø§Ù„Ø³Ø¨Øª"
  };
  return map[n] || n;
}

function parseWorkingDays(value){
  if(!value) return [];
  return String(value)
    .split(/[,ØŒ-]+/)
    .map(s=>normalizeDayName(s))
    .filter(Boolean);
}

function timeToMinutes(t){
  if(!t || typeof t !== "string") return null;
  const trimmed = t.trim();
  const m = trimmed.match(/^(\d{1,2}):(\d{2})(?::(\d{2}))?/);
  if(!m) return null;
  const hh = Number(m[1]);
  const mm = Number(m[2]);
  if(hh > 24 || mm > 59) return null;
  if(hh === 24 && mm !== 0) return null;
  return hh * 60 + mm;
}

function isOpenNow(place){
  const workingDays = parseWorkingDays(place.workingDaysAsString);
  const {dayEn, time24} = getDamascusNow();
  const dayAr = normalizeDayName(dayEn);

  if(workingDays.length && !workingDays.includes(dayAr)){
    return false;
  }

  const openMinutes = timeToMinutes(place.openingTime);
  const closeMinutes = timeToMinutes(place.closingTime);
  const nowMinutes = timeToMinutes(time24);

  if(openMinutes == null || closeMinutes == null || nowMinutes == null){
    return false;
  }

  if(openMinutes === 0 && closeMinutes === 1440){
    return true; // 00:00 -> 24:00
  }

  if(openMinutes === closeMinutes){
    return true; // 24h
  }

  if(closeMinutes > openMinutes){
    return nowMinutes >= openMinutes && nowMinutes < closeMinutes;
  }

  // Overnight shift (e.g., 20:00 -> 06:00)
  return nowMinutes >= openMinutes || nowMinutes < closeMinutes;
}

function escapeWhereValue(value){
  return String(value).replace(/'/g, "\\'");
}

function createQueryBuilder(pageSizeValue=20, pageNumber=1, whereClause=""){
  const params = new URLSearchParams();
  params.set("pageSize", String(pageSizeValue));
  params.set("offset", String((pageNumber - 1) * pageSizeValue));
  if(whereClause){
    params.set("where", whereClause);
  }
  return params;
}

function findPlaces(pageSizeValue=20, pageNumber=1, whereClause=""){
  const params = createQueryBuilder(pageSizeValue, pageNumber, whereClause);
  return fetch(`${PLACES_ENDPOINT}?${params.toString()}`).then(r=>r.json());
}

function findPlaceById(id){
  return fetch(`${PLACES_ENDPOINT}/${encodeURIComponent(id)}`).then(r=>r.json());
}

function fetchDownloadLink(){
  const params = new URLSearchParams();
  params.set("pageSize", "1");
  params.set("offset", "0");
  return fetch(`${APPLOCK_ENDPOINT}?${params.toString()}`).then(r=>r.json());
}

function updatePlaceFields(id, payload){
  return fetch(`${PLACES_ENDPOINT}/${encodeURIComponent(id)}`, {
    method: "PUT",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  }).then(r=>r.json());
}

/* ================= PWA INSTALL PROMPT ================= */
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  
  setTimeout(() => {
    if(!localStorage.getItem('installPromptShown')) {
      document.getElementById('installPrompt').style.display = 'block';
    }
  }, 3000);
});

function installApp() {
  if(deferredPrompt) {
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
      if(choiceResult.outcome === 'accepted') {
        console.log('ØªÙ… ØªØ«Ø¨ÙŠØª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚');
      }
      deferredPrompt = null;
    });
  }
  hideInstallPrompt();
}

function hideInstallPrompt() {
  document.getElementById('installPrompt').style.display = 'none';
  localStorage.setItem('installPromptShown', 'true');
}

/* ================= CATEGORIES DATA ================= */
const categories = {
  'Ø£Ø·Ø¨Ø§Ø¡': ["Ø¹Ø§Ù…", "Ø¯Ø§Ø®Ù„ÙŠØ©", "Ø¹Ø¸Ù…ÙŠØ©", "Ø£Ø·ÙØ§Ù„", "Ø¹ØµØ¨ÙŠØ©", "Ø£Ø³Ù†Ø§Ù†","Ø£Ù†Ù ÙˆØ£Ø°Ù† ÙˆØ­Ù†Ø¬Ø±Ø©","Ù†Ø³Ø§Ø¦ÙŠØ©","Ø¹ÙŠÙˆÙ†","Ù†ÙØ³ÙŠ","Ù‡Ø¶Ù…ÙŠØ©","ØµØ¯Ø±ÙŠØ©","ØªØºØ°ÙŠØ©","Ø¨ÙˆÙ„ÙŠØ©"],
  'Ù…Ø·Ø§Ø¹Ù…': ['ÙØ±ÙˆØ¬ ÙˆØ´Ø§ÙˆØ±Ù…Ø§', 'Ø­Ù…Øµ ÙˆÙÙˆÙ„', 'Ù…Ù†Ø¯ÙŠ ÙˆØ£Ø±Ø²', 'Ø´Ø§Ù…Ù„Ø©','Ù…Ø·Ø¹Ù… ÙˆÙƒØ§ÙÙŠÙ‡', 'ÙˆØ¬Ø¨Ø§Øª Ø³Ø±ÙŠØ¹Ø©', 'ÙÙ„Ø§ÙÙ„', 'Ø¨ÙŠØªØ²Ø§ ÙˆÙ…Ø¹Ø¬Ù†Ø§Øª', 'Ø´Ø§ÙˆØ±Ù…Ø§'],
  'Ø§Ù„Ø¨Ø³Ø©': ["Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø§Ù„Ø¨Ø³Ø©", "Ø±Ø¬Ø§Ù„ÙŠ", "Ù†Ø³Ø§Ø¦ÙŠ", "Ø£Ø·ÙØ§Ù„", "Ù„Ø§Ù†Ø¬Ø±ÙŠ"],
  'Ù„Ø­ÙˆÙ…': ['Ø¯Ø¬Ø§Ø¬', 'Ø®Ø§Ø±ÙˆÙ', 'Ø¬Ù…Ù„', 'Ø¹Ø¬Ù„', 'Ø³Ù…Ùƒ', 'ÙØ±ÙˆØ¬ ÙˆØ³Ù…Ùƒ'],
  'ØµØ§Ù„ÙˆÙ† Ø­Ù„Ø§Ù‚Ø©': ['Ø±Ø¬Ø§Ù„ÙŠ', 'Ù†Ø³Ø§Ø¦ÙŠ'],
  'ØµÙŠØ¯Ù„ÙŠØ§Øª': [],
  'Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©': [],
  'Ø®Ø¶Ø§Ø± ÙˆÙÙˆØ§ÙƒÙ‡': [],
  'Ø£Ø­Ø°ÙŠØ©': [],
  'Ø±ÙˆØ¶Ø© Ø§Ø·ÙØ§Ù„': [],
  'Ù…Ø­Ù„Ø§Øª Ù‚Ù…Ø§Ø´': [],
  'Ù…ÙØ±ÙˆØ´Ø§Øª': [],
  'Ù‚Ø·Ø¹ ØºÙŠØ§Ø±': ['Ø³ÙŠØ§Ø±Ø§Øª', 'Ø¯Ø±Ø§Ø¬Ø§Øª Ù†Ø§Ø±ÙŠØ©', 'Ø¯Ø±Ø§Ø¬Ø§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©'],
  'Ù…Ø·Ø¨Ø¹Ø©': [],
  'Ù…ÙƒØªØ¨Ø©': [],
  'Ø§Ø¹Ù„Ø§Ù': [],
  'Ø®Ø±Ø¯ÙˆØ§Øª': [],
  'Ù…Ø·Ø§Ø¨Ø® ÙˆØ§Ù„Ù…Ù†ÙŠÙˆÙ…': [],
  'Ù…Ø¹Ø±Ø¶ Ø³ÙŠØ§Ø±Ø§Øª': [],
  'Ù…Ø­Ø·Ø© Ù…Ø­Ø±ÙˆÙ‚Ø§Øª': [],
  'Ù…Ø­Ù„Ø§Øª ØµÙŠØ§Ù†Ø©': ['Ù‡ÙˆØ§ØªÙ', 'Ø§Ø¬Ù‡Ø²Ø© Ù…Ù†Ø²Ù„ÙŠØ©', 'ØºØ³Ø§Ù„Ø§Øª', 'Ù…ÙƒÙŠÙØ§Øª'],
  'Ù…Ø­Ù„Ø§Øª Ø£Ø¯ÙˆØ§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©': [],
  'Ø­Ù„ÙˆÙŠØ§Øª ÙˆØ¨ÙˆØ¸Ø©': [],
  'Ù…Ø¹Ø¯Ø§Øª ØµÙ†Ø§Ø¹ÙŠØ©': [],
  'Ù…Ø­Ø§Ù…ÙŠÙ†': [],
  'Ù…ÙƒØ§ØªØ¨ Ø¹Ù‚Ø§Ø±ÙŠØ©': [],
  'Ø´Ø±ÙƒØ© Ø­ÙˆØ§Ù„Ø§Øª': [],
  'Ù…ØºØ³Ù„ ÙˆÙ…Ø´Ø­Ù…': [],
  'ÙƒÙˆÙ…Ø¬ÙŠ': [],
  'Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠ': ['Ø¨Ù†Ø²ÙŠÙ†', 'Ø¯ÙŠØ²Ù„'],
  'Ù…ÙˆØ§Ø¯ Ø¯ÙŠÙƒÙˆØ±': [],
  'Ù…Ø®Ø¨Ø± Ø·Ø¨ÙŠ': [],
  'Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©': [],
  'Ù‡ÙˆØ§ØªÙ Ø¬ÙˆØ§Ù„Ø©': [],
  'Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©': [],
  'ØµØ§Ù„ÙˆÙ†Ø§Øª ØªØ¬Ù…ÙŠÙ„': [],
  'Ù…Ø­Ù„Ø§Øª Ø°Ù‡Ø¨': [],
  'ÙƒÙˆÙÙŠ Ø´ÙˆØ¨': [],
  'Ù…Ø³ØªØ´ÙÙŠØ§Øª': [],
  'Ù…Ø­Ù„Ø§Øª Ù‡ÙˆØ§ØªÙ': [],
  'Ù…Ø­Ù„Ø§Øª ÙƒÙ…Ø¨ÙŠÙˆØªØ±': [],
  'Ù…Ø­Ù„Ø§Øª Ø®ÙŠØ§Ø·Ø©': [],
  'Ù…Ø­Ù„Ù‘Ø§Øª ØªØ­Ù': [],
  'Ù…Ø­Ù„Ù‘Ø§Øª Ø³Ø§Ø¹Ø§Øª': [],
  'Ù…ÙƒØ§ØªØ¨ Ø³ÙŠØ§Ø­ÙŠØ©': [],
  'Ù…Ø±Ø§ÙƒØ² ØªØ¹Ù„ÙŠÙ…ÙŠØ©': [],
  'ØµØ§Ù„Ø§Øª Ù…Ù†Ø§Ø³Ø¨Ø§Øª': [],
  'Ù…Ø­Ù„Ø§Øª Ù„ÙˆØ§Ø²Ù… Ø£Ø·ÙØ§Ù„': [],
  'Ù…Ø­Ù„Ø§Øª Ù„ÙˆØ§Ø²Ù… Ø­Ø¯Ø§Ø¦Ù‚': [],
  'Ù…Ø­Ù„Ø§Øª Ø£Ø¯ÙˆØ§Øª ØµØ­ÙŠØ©': [],
  'Ù…Ø­Ù„Ø§Øª Ø¯Ù‡Ø§Ù†Ø§Øª': [],
  'Ù…Ø­Ù„Ù‘Ø§Øª Ø£Ø¬Ù‡Ø²Ø© ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©': [],
  'Ù…Ø­Ù„Ø§Øª Ù†Ø¸Ø§Ø±Ø§Øª': [],
  'Ù…Ø­Ù„Ø§Øª Ø­Ù„ÙˆÙŠØ§Øª Ø¹Ø±Ø¨ÙŠØ©': [],
  'Ù…Ù‚Ø§Ù‡ÙŠ Ø¥Ù†ØªØ±Ù†Øª': [],
  'ØµØ§Ù„Ø§Øª Ø±ÙŠØ§Ø¶ÙŠØ©': [],
  'Ù…Ø­Ù„Ø§Øª Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø£Ù„ÙŠÙØ©': [],
  'Ù…ÙƒØ§ØªØ¨ Ù‡Ù†Ø¯Ø³ÙŠØ©': [],
  'Ù…ÙƒØ§ØªØ¨ Ù…Ø­Ø§Ø³Ø¨Ø©': [],
  'Ù…Ø­Ù„Ø§Øª Ø£Ø¯ÙˆØ§Øª Ù…ÙƒØªØ¨ÙŠØ©': []
};

const categoryIcons = {
  'Ø£Ø·Ø¨Ø§Ø¡': '<i class="fa-solid fa-user-doctor"></i>',
  'Ù…Ø·Ø§Ø¹Ù…': '<i class="fa-solid fa-utensils"></i>',
  'Ø§Ù„Ø¨Ø³Ø©': '<i class="fa-solid fa-shirt"></i>',
  'Ù„Ø­ÙˆÙ…': '<i class="fa-solid fa-drumstick-bite"></i>',
  'ØµØ§Ù„ÙˆÙ† Ø­Ù„Ø§Ù‚Ø©': '<i class="fa-solid fa-scissors"></i>',
  'ØµÙŠØ¯Ù„ÙŠØ§Øª': '<i class="fa-solid fa-prescription-bottle-medical"></i>',
  'Ù…ÙˆØ§Ø¯ ØºØ°Ø§Ø¦ÙŠØ©': '<i class="fa-solid fa-basket-shopping"></i>',
  'Ø®Ø¶Ø§Ø± ÙˆÙÙˆØ§ÙƒÙ‡': '<i class="fa-solid fa-apple-whole"></i>',
  'Ø£Ø­Ø°ÙŠØ©': '<i class="fa-solid fa-shoe-prints"></i>',
  'Ø±ÙˆØ¶Ø© Ø§Ø·ÙØ§Ù„': '<i class="fa-solid fa-children"></i>',
  'Ù…Ø­Ù„Ø§Øª Ù‚Ù…Ø§Ø´': '<i class="fa-solid fa-thread"></i>',
  'Ù…ÙØ±ÙˆØ´Ø§Øª': '<i class="fa-solid fa-couch"></i>',
  'Ù‚Ø·Ø¹ ØºÙŠØ§Ø±': '<i class="fa-solid fa-gears"></i>',
  'Ù…Ø·Ø¨Ø¹Ø©': '<i class="fa-solid fa-print"></i>',
  'Ù…ÙƒØªØ¨Ø©': '<i class="fa-solid fa-book"></i>',
  'Ø§Ø¹Ù„Ø§Ù': '<i class="fa-solid fa-seedling"></i>',
  'Ø®Ø±Ø¯ÙˆØ§Øª': '<i class="fa-solid fa-screwdriver-wrench"></i>',
  'Ù…Ø·Ø§Ø¨Ø® ÙˆØ§Ù„Ù…Ù†ÙŠÙˆÙ…': '<i class="fa-solid fa-kitchen-set"></i>',
  'Ù…Ø¹Ø±Ø¶ Ø³ÙŠØ§Ø±Ø§Øª': '<i class="fa-solid fa-car-side"></i>',
  'Ù…Ø­Ø·Ø© Ù…Ø­Ø±ÙˆÙ‚Ø§Øª': '<i class="fa-solid fa-gas-pump"></i>',
  'Ù…Ø­Ù„Ø§Øª ØµÙŠØ§Ù†Ø©': '<i class="fa-solid fa-screwdriver-wrench"></i>',
  'Ù…Ø­Ù„Ø§Øª Ø£Ø¯ÙˆØ§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©': '<i class="fa-solid fa-plug"></i>',
  'Ø­Ù„ÙˆÙŠØ§Øª ÙˆØ¨ÙˆØ¸Ø©': '<i class="fa-solid fa-ice-cream"></i>',
  'Ù…Ø¹Ø¯Ø§Øª ØµÙ†Ø§Ø¹ÙŠØ©': '<i class="fa-solid fa-industry"></i>',
  'Ù…Ø­Ø§Ù…ÙŠÙ†': '<i class="fa-solid fa-scale-balanced"></i>',
  'Ù…ÙƒØ§ØªØ¨ Ø¹Ù‚Ø§Ø±ÙŠØ©': '<i class="fa-solid fa-house"></i>',
  'Ø´Ø±ÙƒØ© Ø­ÙˆØ§Ù„Ø§Øª': '<i class="fa-solid fa-money-bill-transfer"></i>',
  'Ù…ØºØ³Ù„ ÙˆÙ…Ø´Ø­Ù…': '<i class="fa-solid fa-soap"></i>',
  'Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠ': '<i class="fa-solid fa-wrench"></i>',
  'Ù…ÙˆØ§Ø¯ Ø¯ÙŠÙƒÙˆØ±': '<i class="fa-solid fa-palette"></i>',
  'Ù…Ø®Ø¨Ø± Ø·Ø¨ÙŠ': '<i class="fa-solid fa-vials"></i>',
  'Ø£Ø¬Ù‡Ø²Ø© Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©': '<i class="fa-solid fa-microchip"></i>',
  'Ù‡ÙˆØ§ØªÙ Ø¬ÙˆØ§Ù„Ø©': '<i class="fa-solid fa-mobile-screen-button"></i>',
  'Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©': '<i class="fa-solid fa-bolt"></i>',
  'ØµØ§Ù„ÙˆÙ†Ø§Øª ØªØ¬Ù…ÙŠÙ„': '<i class="fa-solid fa-spa"></i>',
  'Ù…Ø­Ù„Ø§Øª Ø°Ù‡Ø¨': '<i class="fa-solid fa-gem"></i>',
  'ÙƒÙˆÙÙŠ Ø´ÙˆØ¨': '<i class="fa-solid fa-mug-hot"></i>',
  'Ù…Ø³ØªØ´ÙÙŠØ§Øª': '<i class="fa-solid fa-hospital"></i>',
  'Ù…Ø­Ù„Ø§Øª Ù‡ÙˆØ§ØªÙ': '<i class="fa-solid fa-mobile-screen-button"></i>',
  'Ù…Ø­Ù„Ø§Øª ÙƒÙ…Ø¨ÙŠÙˆØªØ±': '<i class="fa-solid fa-laptop"></i>',
  'Ù…Ø­Ù„Ø§Øª Ø®ÙŠØ§Ø·Ø©': '<i class="fa-solid fa-needle"></i>',
  'Ù…Ø­Ù„Ù‘Ø§Øª Ø³Ø§Ø¹Ø§Øª': '<i class="fa-solid fa-clock"></i>',
  'Ù…ÙƒØ§ØªØ¨ Ø³ÙŠØ§Ø­ÙŠØ©': '<i class="fa-solid fa-suitcase-rolling"></i>',
  'Ù…Ø±Ø§ÙƒØ² ØªØ¹Ù„ÙŠÙ…ÙŠØ©': '<i class="fa-solid fa-graduation-cap"></i>',
  'ØµØ§Ù„Ø§Øª Ø±ÙŠØ§Ø¶ÙŠØ©': '<i class="fa-solid fa-dumbbell"></i>',
  'Ù…Ø­Ù„Ø§Øª Ø­ÙŠÙˆØ§Ù†Ø§Øª Ø£Ù„ÙŠÙØ©': '<i class="fa-solid fa-paw"></i>',
  'Ù…ÙƒØ§ØªØ¨ Ù‡Ù†Ø¯Ø³ÙŠØ©': '<i class="fa-solid fa-compass-drafting"></i>',
  'Ù…ÙƒØ§ØªØ¨ Ù…Ø­Ø§Ø³Ø¨Ø©': '<i class="fa-solid fa-file-invoice-dollar"></i>',
  'Ù…Ø­Ù„Ø§Øª Ø£Ø¯ÙˆØ§Øª Ù…ÙƒØªØ¨ÙŠØ©': '<i class="fa-solid fa-pen-ruler"></i>'
};

/* ================= NAVIGATION ================= */
function go(pageId, push=true, stateExtras=null){
  document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
  document.getElementById(pageId).classList.remove('hidden');
  if(push){
    history.pushState({page: pageId, ...(stateExtras || {})}, "", `#${pageId}`);
  }
}

function goBackFromDetails(){
  history.back();
}

function goBackFromPlaces(){
  history.back();
}

window.addEventListener("popstate", (e)=>{
  const state = e.state || {page:"home"};
  if(state.page === "places" && state.mode === "subcategories" && state.category){
    loadSubcategories(state.category, false);
    return;
  }
  if(state.page === "places" && state.mode === "places" && state.category){
    loadPlaces(state.category, state.subcategory || null, false, false);
    return;
  }
  go(state.page || "home", false);
});

/* ================= THEME ================= */
/* ================= SEARCH ================= */
function setupSearch(){
  const searchInput = document.getElementById("searchInput");
  const searchResults = document.getElementById("searchResults");
  const searchBtn = document.getElementById("searchBtn");
  const areaSelect = document.getElementById("areaSelect");

  searchBtn.addEventListener("click", function(){
    const query = searchInput.value.trim();
    if(query.length < 2){
      alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ 2 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¨Ø­Ø«");
      return;
    }
    searchPlacesAPI(query);
  });

  searchInput.addEventListener("keydown", function(e){
    if(e.key === "Enter"){
      const query = searchInput.value.trim();
      if(query.length < 2){
        alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ 2 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ø¨Ø­Ø«");
        return;
      }
      searchPlacesAPI(query);
    }
  });

  document.addEventListener("click", function(e){
    if(!searchResults.contains(e.target) && e.target !== searchInput && e.target !== searchBtn){
      searchResults.style.display = "none";
    }
  });

  areaSelect.addEventListener("change", function(){
    selectedArea = this.value.trim();
    if(listMode === "places" && currentCategory){
      page = 1;
      loadPlaces(currentCategory, currentSubcategory);
    }
  });
}

function searchPlacesAPI(query){
  const searchResults = document.getElementById("searchResults");
  searchResults.innerHTML = "";
  searchResults.style.display = "block";

  const whereParts = [`name LIKE '%${escapeWhereValue(query)}%'`];
  if(selectedArea){
    whereParts.push(`area='${escapeWhereValue(selectedArea)}'`);
  }
  const where = whereParts.join(" AND ");
  findPlaces(20, 1, where)
  .then(data=>{
    if(Array.isArray(data) && data.length===0){
      searchResults.innerHTML = '<div class="search-result-item">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</div>';
      return;
    }
    if(data && !Array.isArray(data) && data.message){
      searchResults.innerHTML = `<div class="search-result-item">Ø®Ø·Ø£: ${data.message}</div>`;
      return;
    }
    if(!Array.isArray(data)){
      searchResults.innerHTML = '<div class="search-result-item">Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø®Ø§Ø¯Ù…</div>';
      return;
    }

    data.forEach(p=>{
      const div = document.createElement("div");
      div.className = "search-result-item";
      div.innerHTML = `<strong>${p.name}</strong>
                       <div class="search-result-category">${p.Categoriestype || p.category}</div>`;
      div.onclick = ()=>{
        lastListPage = "home";
        loadDetails(p.objectId || p.id);
        searchResults.style.display = "none";
      }
      searchResults.appendChild(div);
    });
  })
  .catch(err=>{
    console.error(err);
    searchResults.innerHTML = '<div class="search-result-item">ØªØ¹Ø°Ø± Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…</div>';
  });
}

/* ================= CATEGORIES ================= */
function loadCategories(){
  const container = document.getElementById("categories");
  container.innerHTML = "";

  Object.keys(categories).forEach(cat=>{
    const icon = categoryIcons[cat] || '<i class="fa-solid fa-tag"></i>';
    const card = document.createElement("div");
    card.className = "card";
    card.innerHTML = `<div class="card-icon">${icon}</div><div>${cat}</div>`;
    card.onclick = ()=>{
      if(categories[cat].length>0){
        loadSubcategories(cat);
      } else {
        page=1;
        loadPlaces(cat);
      }
    };
    container.appendChild(card);
  });
}

function loadSubcategories(cat, push=true){
  currentCategory = cat;
  currentSubcategory = null;
  listMode = "subcategories";
  if(push){
    go("places", false);
    history.pushState({page:"places", mode:"subcategories", category:cat}, "", "#places");
  } else {
    go("places", false);
  }
  const subGrid = document.createElement("div");
  subGrid.className = "subcategory-grid";
  categories[cat].forEach(sub=>{
    const subCard = document.createElement("div");
    subCard.className = "card";
    subCard.textContent = sub;
    subCard.onclick = ()=>{
      page=1;
      currentSubcategory=sub;
      loadPlaces(cat, sub);
    };
    subGrid.appendChild(subCard);
  });
  const title = document.getElementById("placesTitle");
  title.textContent = `Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„ÙØ±Ø¹ÙŠ Ù„Ù€ ${cat}`;
  const list = document.getElementById("placesList");
  list.classList.remove("places-grid");
  list.innerHTML = "";
  list.appendChild(subGrid);
}

/* ================= PLACES ================= */
function loadPlaces(cat, subcat=null, append=false, push=true){
  currentCategory = cat;
  currentSubcategory = subcat;
  lastListPage = "places";
  listMode = "places";
  if(push){
    go("places", false);
    history.pushState({page:"places", mode:"places", category:cat, subcategory:subcat}, "", "#places");
  } else {
    go("places", false);
  }

  const title = subcat ? `${cat} - ${subcat}` : cat;
  document.getElementById("placesTitle").textContent = title;

  const list = document.getElementById("placesList");
  list.classList.add("places-grid");
  if(!append) list.innerHTML="";

  if(!append){
    for(let i=0;i<3;i++){
      const skeleton = document.createElement("div");
      skeleton.className="item skeleton skeleton-item";
      list.appendChild(skeleton);
    }
  }

  const whereParts = [`category='${escapeWhereValue(cat)}'`];
  if(subcat) whereParts.push(`Categoriestype='${escapeWhereValue(subcat)}'`);
  if(selectedArea) whereParts.push(`area='${escapeWhereValue(selectedArea)}'`);
  const where = whereParts.join(" AND ");

  loading=true;

  findPlaces(pageSize, page, where)
  .then(data=>{
    loading=false;
    if(!append) list.innerHTML="";
    if(data.length===0 && !append){
      const emptyMsg = document.createElement("div");
      emptyMsg.className="item";
      emptyMsg.style.textAlign="center";
      emptyMsg.innerHTML="Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù…Ø§ÙƒÙ† ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ Ø­Ø§Ù„ÙŠØ§Ù‹";
      list.appendChild(emptyMsg);
      return;
    }
    allPlaces = append ? allPlaces.concat(data) : data;

    data.forEach(p=>{
      const div=createPlaceItem(p, cat);
      div.onclick=()=>loadDetails(p.objectId || p.id);
      list.appendChild(div);
    });
  })
  .catch(err=>{
    loading=false;
    console.error(err);
  });
}

function createPlaceItem(place, cat){
  const div = document.createElement("div");
  div.className="item";

  const isOpen = isOpenNow(place);
  const subName = place.Categoriestype || currentSubcategory || "";

  div.innerHTML=`
    <div class="item-name">${place.name}</div>
    <div class="item-status">
      <span class="badge ${isOpen ? 'badge-open':'badge-closed'}">
        ${isOpen ? 'ğŸŸ¢ Ù…ÙØªÙˆØ­':'ğŸ”´ Ù…ØºÙ„Ù‚'}
      </span>
    </div>
    <div class="item-footer">
      <span>ğŸ‘ ${place.views || 0}</span>
    </div>
  `;
  return div;
}

document.getElementById("placesList").addEventListener("scroll", function(){
  const el = this;
  if(listMode !== "places") return;
  if(!loading && el.scrollTop + el.clientHeight >= el.scrollHeight-50){
    page++;
    loadPlaces(currentCategory, currentSubcategory, true);
  }
});

// Initialize history state for proper back navigation
(function initHistory(){
  const hashPage = location.hash ? location.hash.replace("#","") : "";
  const initialPage = (hashPage && document.getElementById(hashPage)) ? hashPage : "home";
  history.replaceState({page: initialPage}, "", `#${initialPage}`);
  go(initialPage, false);
})();

/* ================= DETAILS ================= */
function loadDetails(id){
  currentPlaceId=id;
  findPlaceById(id)
  .then(p=>{
    const opening = p.openingTime || p.opening || p.open || "";
    const closing = p.closingTime || p.closing || p.close || "";
    const hoursValue =
      (opening || closing)
        ? `${opening || "-"} - ${closing || "-"}`
        : (p.hours || p.workingHours || p.openingHours || p.workHours || "-");
    const rawWorkdays = p.workingDaysAsString || p.workdays || p.workingDays || p.workDays || p.days || p.businessDays || "";
    const workdaysList = parseWorkingDays(rawWorkdays);
    const workdaysValue = workdaysList.length ? workdaysList.join(" - ") : "-";
    const currentViews = Number(p.views || 0);
    const nextViews = currentViews + 1;

    go("details");
    document.getElementById("name").textContent=p.name;
    const openNow = isOpenNow(p);
    document.getElementById("statusBadge").innerHTML = `<span class="badge ${openNow?'badge-open':'badge-closed'}">${openNow?'ğŸŸ¢ Ù…ÙØªÙˆØ­':'ğŸ”´ Ù…ØºÙ„Ù‚'}</span>`;
    document.getElementById("category").textContent = `${p.Categoriestype || currentSubcategory || ''}${p.category ? ` - ${p.category || currentCategory}` : ''}`;
    document.getElementById("phone").textContent=p.phone||'-';
    document.getElementById("hours").textContent=hoursValue;
    document.getElementById("workdays").textContent=workdaysValue;
    document.getElementById("views").textContent=String(nextViews);

    updatePlaceFields(id, {views: nextViews}).catch(console.error);
  })
  .catch(console.error);
}

/* ================= MAP ================= */
function openMap(){
  go("mapPage");
  findPlaceById(currentPlaceId)
  .then(p=>{
    const lat=p.lat ?? p.latitude ?? 0;
    const lng=p.lng ?? p.longitude ?? 0;
    if(map) map.remove();
    map = L.map('map').setView([lat,lng],16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);
    L.marker([lat,lng]).addTo(map).bindPopup(p.name).openPopup();
    setTimeout(()=>map.invalidateSize(), 0);
  });
}

/* ================= INIT ================= */
setupSearch();
loadCategories();
fetchDownloadLink()
  .then(data=>{
    if(!Array.isArray(data) || data.length === 0) return;
    const link = data[0].dwonloadlink || data[0].downloadlink || "";
    if(!link) return;
    const btn = document.getElementById("downloadBtn");
    if(btn) btn.href = link;
  })
  .catch(console.error);
</script>

</body>
</html>
